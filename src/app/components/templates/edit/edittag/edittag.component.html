<section class="my-4 container">

  <h2 class="mb-4">Edit tag</h2>

  <div *ngIf="tag">
    <div *ngIf="tag.innerTagList[tag.innerTagList.length - 1].state !== 'VALIDATING' &&
     tag.innerTagList[tag.innerTagList.length - 1].state !== 'DRAFT'">
      <button type="button" class="btn btn-primary mb-2 float-right" data-toggle="modal" data-target="#modalInnerPage">View all version</button>
      <br>
      <div class="modal" id="modalInnerPage" tabindex="-1" role="dialog" aria-labelledby="modal1-label">
        <div class="modal-dialog" style="max-width: 80%">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Timeline</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <ul *ngFor="let inner of tag.innerTagList" class="timeline">
                <li *ngIf="inner.state !== 'DRAFT' && inner.state !== 'VALIDATING'" class="timeline-inverted">
                  <div class="timeline-badge {{ inner.state === 'VALIDATED' ? 'success' : 'danger' }}"></div>
                  <div class="timeline-panel">
                    <div class="timeline-heading">
                      <h4 class="timeline-title">{{ inner.name }}</h4>
                      <p class="mb-0"><small class="text-muted">version {{ inner.version }} is {{ inner.state }} at {{ inner.voteList[inner.voteList.length - 1].createdAt| date:'dd MMMM yyyy' }} by {{ inner.user.username }}</small></p>
                      <p><small *ngFor="let vote of inner.voteList; let index = index" class="text-muted">{{ vote.user.username + (inner.voteList.length - 1 !== index ? ', ' : ' have voted') }}</small></p>
                    </div>
                    <div class="timeline-body">
                      <p>{{ inner.content }}</p>
                      <ul *ngIf="inner.messageList.length !== 0" class="timeline-message">
                        <li *ngFor="let message of inner.messageList" class="{{ userColor(message.user.id, inner) }}">
                          <h5>{{ message.user.username }}</h5>
                          <p><small class="text-muted">{{ message.createdAt| date:'dd MMMM yyyy - HH:mm' }}</small></p>
                          <p>{{ message.content }}</p>
                          <small *ngIf="message.isEdited">Edited</small>
                        </li>
                      </ul>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <!-- <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div> -->
          </div>
        </div>
      </div>
    </div>

    <form *ngIf="tag.innerTagList[0].state === 'DRAFT'; else elseBlock" [formGroup]="editInnerTagForm">
      <div class="form-group">
        <label>Name:</label>
        <input type="text" class="form-control" formControlName="name">
        <small class="form-text text-muted">The description is use for je sqis pqs auoi voilq pourauoi faut la taper</small>
        <div *ngIf="editInnerTagForm.get('name').invalid &&
          (editInnerTagForm.get('name').dirty || editInnerTagForm.get('name').touched)" >
          <p *ngIf="editInnerTagForm.get('name').errors.required"
             class="note text-danger">Please type a description.</p>
          <p *ngIf="editInnerTagForm.get('name').errors.minlength || editInnerTagForm.get('name').errors.minlength"
             class="note text-danger">Please insert minimum of 2 characters and a maximum of 32 characters.</p>
        </div>
      </div>
      <div class="form-group">
        <label>Description:</label>
        <textarea formControlName="content" class="form-control"></textarea>
        <small class="form-text text-muted">The description is use for je sqis pqs auoi voilq pourauoi faut la taper</small>
        <div *ngIf="editInnerTagForm.get('content').invalid &&
          (editInnerTagForm.get('contentTag').dirty || editInnerTagForm.get('content').touched)" >
          <p *ngIf="editInnerTagForm.get('content').errors.required"
             class="note text-danger">Please type a description.</p>
          <p *ngIf="editInnerTagForm.get('content').errors.minlength || editInnerTagForm.get('content').errors.minlength"
             class="note text-danger">Please insert minimum of 32 characters and a maximum of 1024 characters.</p>
        </div>
      </div>
      <button type="button" class="btn btn-primary mr-2" (click)="updateInnerTag()">Save Draft</button>
      <button type="button" class="btn btn-primary" [disabled]="editInnerTagForm.invalid" (click)="validationInnerTag()">Validation</button>
    </form>
    <ng-template #elseBlock>
      <h2>{{ tag.innerTagList[0].name }}</h2>
      <p>{{ tag.innerTagList[0].content }}</p>
    </ng-template>
    <div *ngIf="tag.innerTagList[0].state !== 'DRAFT'" class="progress mb-2">
      <div class="progress-bar bg-success" role="progressbar" style="{{ 'width:' + (tag.innerTagList[0].favour * 20).toString() + '%' }}" aria-valuenow="{{ tag.innerTagList[0].favour * 20 }}" aria-valuemin="0" aria-valuemax="100">{{ tag.innerTagList[0].favour }}/5</div>
      <div class="progress-bar bg-danger" role="progressbar" style="{{ 'width:' + (tag.innerTagList[0].against * 20).toString() + '%' }}" aria-valuenow="{{ tag.innerTagList[0].against * 20 }}" aria-valuemin="0" aria-valuemax="100">{{ tag.innerTagList[0].against }}/5</div>
    </div>
    <button *ngIf="tag.innerTagList[0].state === 'VALIDATING' && canVote(tag.innerTagList[0])" type="button" class="btn btn-primary mr-2" (click)="voteInnerTag(tag.innerTagList[0].id, 1)">Favour</button>
    <button *ngIf="tag.innerTagList[0].state !== 'DRAFT' && tag.innerTagList[0].state !== 'VALIDATING'" type="button" class="btn btn-primary" (click)="addInnerTag(tag.innerTagList[0].id, tag.id)">New title/description</button>
    <form [formGroup]="messageInnerTagForm" class="row mt-2">
      <div class="form-group col">
        <input type="text" formControlName="content" class="form-control" placeholder="Type your message here...">
      </div>
      <div class="col">
        <button type="button" class="btn btn-primary mr-2" [disabled]="messageInnerTagForm.invalid" (click)="addInnerTagMessage(tag.innerTagList[0].id)">Send</button>
        <button *ngIf="tag.innerTagList[0].state === 'VALIDATING' && canVote(tag.innerTagList[0])" type="button" class="btn btn-primary" [disabled]="messageInnerTagForm.invalid" (click)="voteInnerTag(tag.innerTagList[0].id, 0)">Against</button>
      </div>
    </form>

    <ul *ngIf="tag.innerTagList[0].messageList.length !== 0" class="timeline-message">
      <li *ngFor="let message of tag.innerTagList[0].messageList" class="{{ userColor(message.user.id, tag.innerTagList[0]) }}">
        <h5>{{ message.user.username }}</h5>
        <p><small class="text-muted">{{ message.createdAt| date:'dd MMMM yyyy - HH:mm' }}</small></p>
        <p>{{ message.content }}</p>
        <small *ngIf="message.isEdited">Edited</small>
      </li>
    </ul>
  </div>

</section>
